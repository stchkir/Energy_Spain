---
title: "Year-ahead forcast of electricity prices in Spain"
author: "Stephan Kirchhoff"
date: "02 May 2020"
output: pdf_document
---

# Introduction
## An introduction/overview/executive summary section that describes the dataset and variables, and summarizes the goal of the project and key steps that were performed.

The goal of this work is to train an algorithm that forecasts the electricity prices in Spain based on historic spot market price developments. The algorithm is trained on the electricity prices from 2014 to 2017 and tested using the 2018 prices.

The dataset is a daily time series of electricity demand, generation and prices in Spain from 2014 to 2018. It is gathered from ESIOS, a website managed by REE (Red Electrica Espa√±ola) which is the Spanish TSO (Transmission System Operator). It was made available on kaggle:
https://www.kaggle.com/manualrg/spanish-electricity-market-demand-gen-price/

Original energy and price data can be downloaded from : https://www.esios.ree.es/en

The idea is to forecast electricity prices for the next year, using linear regression, trend decomposition and Holt Winters seasonal method. Using these methods the electrcitiy prices could be predicted with a RMSE of below 9 EUR/MWh. The average electrcitiy price is at approximately 46 EUR/MWh.

The dataset also contains generation data from all relevant energy sources,like wind, coal, nuclear or hydro, which could serve as predictor variables. Graphical exploration and correlation analyses show that especially the wind energy generation has a strong negative correlation to the electricity price, i.e. prices are significantly lower when a lot of wind energy is generated. 

Having a wind speed forecast could significantly reduce the error in the electricity price forecast. In this work the energy generation data was not considered, because no forecast was available on the considered time scale. Still, patterns in the energy generation, like wind seasons, should already be reflected in the seasonal price effects.

```{r data, include=FALSE}
### Load data from Git Repository
git <- "https://raw.githubusercontent.com/stchkir/Energy_Spain/master/data/spain_energy_market.csv"
temp <- tempfile()
download.file(git,temp)
energy_data <- read.csv(temp,sep=",")
unlink(temp)
```

```{r packages, include=FALSE}
### Load Packages
library("lubridate")
library("tidyverse")
library("caret")
library("corrplot")
library("RColorBrewer")
library("forecast")
library("zoo")
library("knitr")
```

# Methods/Analysis
## A methods/analysis section that explains the process and techniques used, including data cleaning, data exploration and visualization, any insights gained, and your modeling approach. At least two different models or algorithms must be used, with at least one being more advanced than simple linear regression for prediction problems.

The dataset contains six variables, as seen in the following table. Data is reported in a daily frequency, in this case the Spanish electricity spot market price in Spain.
```{r head_data, echo=FALSE}
head(energy_data) %>% kable()
```

The structure of the data can be better understood when filtering for the first reporting date. For each date various parameters are reported in a tidy format, specified in the column *name*. The Spanish spot market price is reported together with the Portuguese and French electricity spot market prices (in EUR/MWh). It also contains the expected energy demand and the energy generation plan in Spain, split by energy source (in MWh). Finally it contains data on the trading between markets, i.e. the energy that is assigned to Spain and France on the following day, and the energy export and import from and to France and Portugal (in MWh). The value for each is reported in the column *value*.

It can be seen that each parameter is assigned to an unique *ID*. Only the spot market prices for Spain, France and Portgual use the same ID 600. These are differentiated via the variables *geoid* and *geoname*, which are directly linked. Both parameters are only defined for the spot market prices, to differentiate between markets.

Finally it can be seen that the spot market prices are dublicated. Once without a parameter indicated in column *name* and once with the *name* parameter specified.
```{r dublicates, echo=FALSE}
### Change time to datetime format
energy_data$datetime <- as_datetime(energy_data$datetime)
energy_data <- energy_data %>% mutate(year=year(datetime), month=month(datetime),
                                      week=week(datetime), wday=wday(datetime),
                                      hour=hour(datetime))


energy_data %>% filter(datetime==datetime[1]) %>% 
select(-datetime,-year,-month,-week,-wday,-hour) %>% 
mutate(value=round(value,2)) %>% kable()
```

The dataset was then prepared for further processing. The *datetime* variable was changed to a **dateime** format. Additional variables were added, indicating the *year*, *month*, *week*, weekday (*wday*) and *hour*. Then dublicates for the spot market prices were eliminated by removing empty rows in the column *name*. The variables in the column *name* were then renamed, using English terms (*key*). Finally the parameters in the column *key* were spread to columns to have one date point per day. Like this correlations between spot market prices and generation and demand data could be analyzed.
```{r data_cleaning, include=FALSE}
### Clean up dublicates of spot prices
energy_data <- energy_data %>% filter(name!="") # remove rows without name variable

### Change variable names to English
variables <- energy_data %>% group_by(name) %>% 
  summarise(id = paste(unique(id), collapse = ', ')) 

variables_new <- c("total_demand_plan",
                   "total_demand_actual",
                   "trade_ESP",
                   "trade_FRA", 
                   "plan_coal",
                   "plan_combicycle",
                   "plan_wind",
                   "plan_gas",
                   "plan_nuclear",
                   "plan_pv",
                   "total_generation_plan",
                   "plan_hydro",
                   "plan_reverse_hydro",
                   "spot_price_ESP",
                   "spot_price_FRA",
                   "spot_price_POR",
                   "export_FRA",
                   "import_FRA",
                   "export_POR",
                   "import_POR")

variables <- variables %>% mutate(key=variables_new)

### Add English names and remove variables without additional information
energy_data <- energy_data %>% left_join(select(variables,-id),by="name") %>%
  select(-id,-name,-geoid,-geoname)
```

```{r data_spread}
### Spread table (to link spot prices to other variables)
energy_data_spread <- energy_data %>% spread(key=key,value=value)
```

This is an overview of the variables and their English version
``` {r variables, echo=FALSE}
variables %>% kable()
```

The dataset is then spread into a train set (*model_data*), consisting of the years 2014-2017, and the test set (*test_data*) containing year 2018 data. The goal is to train a model on the initial 4 years and test it on the last one. Any further data exploration and model training will solely use the train set.
```{r train and test set}
### Use year 2018 as test model
model_data <- energy_data_spread %>% filter(year!=2018)
test_data <- energy_data_spread %>% filter(year==2018)
```

Since the objective is to predict the Spanish spot market prices, the average price for years 2014-2017 was calculated in a first step.
```{r mean_price, echo=FALSE}
### Calculate mean spot price by country
mean_price <- model_data %>% 
  summarise(mean_price_ESP=mean(spot_price_ESP),
            mean_price_FRA=mean(spot_price_FRA),
            mean_price_POR=mean(spot_price_POR))

mean_price %>% kable()

### Calculate error in train set using naive method
RMSE_model <- data.frame(method="naive",
                              accuracy=RMSE(mean_price$mean_price_ESP,
                                            model_data$spot_price_ESP))
```

Using the mean price as prediction for the electricity price in the train set leads to a RMSE of `r round(RMSE_model[1,2],1)`. 

Looking at the graphical representation of the price development in years 2014-2017 you can rather see a seasonal pattern, with a positive trend.

```{r price_development, echo=FALSE}
model_data %>% 
  gather(key=market,value=value,spot_price_ESP,spot_price_FRA,spot_price_POR) %>%
  ggplot(aes(datetime, value)) +
  geom_point(aes(color=market))
```


# Results
## A results section that presents the modeling results and discusses the model performance.
                        
# Conclusion 
## A conclusion section that gives a brief summary of the report, its potential impact, its limitations, and future work.
